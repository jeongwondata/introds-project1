---
title: "Object 2"
author: "Jeongwon Yoo"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    number_sections: false
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document:
    toc: true
    toc_depth: 3
---
  
```{r setup, include=FALSE}
# Set CRAN mirror
options(repos = c(CRAN = "https://cloud.r-project.org"))

# Install required packages if they are not already installed
required_packages <- c("sf","ggplot2","viridis","dplyr","lubridate",
                       "corrplot","tigris","readr","tidyr",
                       "spatialreg","spdep")
new_packages <- required_packages[!(required_packages %in% installed.packages()[, "Package"])]
if (length(new_packages)) {
  install.packages(new_packages)
}

# Load libraries
library(sf)
library(ggplot2)
library(viridis)
library(dplyr)
library(lubridate)
library(tigris)
library(readr)
library(tidyr)
library(corrplot)
library(spatialreg)
```


```{r include=FALSE} 
# Set global chunk options
knitr::opts_chunk$set(echo = FALSE, results = "markup", warning = FALSE, message = FALSE)

# Set options for number display format
options(scientific = TRUE, digits = 3)
```

# Object 2

Investigate Environmental Factors Influencing Fire Incidences-Jeongwon Yoo

## 1. Data Integration

```{r}
# Read CSV
clean_df = '/Users/jeongwonyoo/Documents/GitHub/introds-project1/Fire incidences DC_VA_MD_cleaned.csv' 
raw_df = '/Users/jeongwonyoo/Documents/GitHub/introds-project1/Wildfire_Dataset.csv'

library('readr')
clean_df = read_csv(clean_df)
raw_df = read_csv(raw_df)

# Make row_df columns names same as clean_df
names(raw_df) = toupper(names(raw_df))

# Add State name on raw data
options(tigris_use_cache = TRUE)

states <- tigris::states(cb = TRUE, year = 2023) %>%
    st_transform(4326) %>%
    select(STUSPS, NAME, geometry)

sf_raw <- st_as_sf(raw_df %>% filter(!is.na(LATITUDE), !is.na(LONGITUDE)),coords = c("LONGITUDE","LATITUDE"), crs = 4326, remove=FALSE)

raw_with_state_poly <- st_join(sf_raw, states, join = st_within) %>%
    st_drop_geometry() %>%
    rename(STATE = STUSPS)

# sort target data(state(VA,DC,MD),time(2018))
target_states <- c("DC","MD","VA")
target_year   <- 2018
cols_keep     <- c("STATE","FIRE_YEAR","Month","LATITUDE","LONGITUDE",
                   "DATETIME","PR","RMAX","RMIN","SPH","SRAD","TMMN",
                  "TMMX","VS","BI","FM100","FM1000","ERC","ETR","PET","VPD")

# Make sub dataset of clean_df
clean_sub <- clean_df %>%
    filter(STATE %in% target_states,
           FIRE_YEAR == target_year) %>% 
    select(any_of(cols_keep))

# Make sub dataset of raw_df
raw_sub <- raw_with_state_poly %>%
    filter(STATE %in% target_states,
           lubridate::year(lubridate::as_datetime(DATETIME)) == target_year) %>%
    drop_na(LATITUDE, LONGITUDE) %>%
    select(any_of(cols_keep))

# organized data check
str('raw_sub')
```

Call new dataset for the analysis
```{r}
dp = '/Users/jeongwonyoo/Documents/GitHub/introds-project1/clean_object2_2018_DCMDVA.csv'
object2 = read_csv(dp)
```

## 2. Correlation Analysis
Correlation Analysis

```{r}
env_vars <- object2 %>% select(PR, RMAX, RMIN, SPH, SRAD, TMMN, TMMX, VS, FM100, FM1000, ERC, ETR, PET, VPD)
cor_mat <- cor(env_vars, use = "complete.obs")
corrplot(cor_mat, method = "color", tl.cex = 0.8)
```

Figure 1. Correlation heatmap.
The heatmap shows strong negative correlations between ERC and fuel moisture variables (FM100, FM1000), indicating that wetter fuels are associated with lower fire potential. ERC is moderately positively correlated with atmospheric dryness and heat (VPD, TMMX). Humidity indicators (RMAX, RMIN, SPH) are strongly negatively correlated with VPD, which is expected since higher humidity coincides with lower vapor pressure deficit. FM100 and FM1000 are highly positively correlated, so they should not be used together in the same model due to multicollinearity risk.

### 2.1. Raster Maps

Figure: Maximum Temperature Distribution (°C)
```{r}
library(dplyr); library(ggplot2)

plot_raster <- function(df, var, bins = 60, to_celsius = FALSE) {
    z <- if (to_celsius) df[[var]] - 273.15 else df[[var]]
    ggplot(df, aes(LONGITUDE, LATITUDE, z = z)) +
        stat_summary_2d(fun = mean, bins = bins, na.rm = TRUE) +
        coord_fixed(expand = FALSE) +
        scale_fill_viridis_c(name = var) +
        labs(title = paste(var, "Distribution")) +
        theme_minimal(base_size = 12)
}
```

```{r}
plot_raster(object2, "TMMX", bins = 70, to_celsius = TRUE)
```

TMMX(C) binned raster map

- The binned raster map shows a west-to-east warming gradient, with higher maximum temperatures concentrated in the eastern and southeastern bins and cooler conditions in the western highlands, consistent with regional topography and supporting the observed positive association between heat and fire potential.

```{r}
plot_raster(object2, "VPD",  bins = 70)
```

VPD binned raster map

- Higher VPD (drier air) pockets appear in many of the same eastern and central areas that are warmer
- The co-location of high TMMX and high VPD indicates jointly hot-dry conditions that elevate fire potential

```{r}
plot_raster(object2, "FM100", bins = 70)
```

FM100 binned raster map

- Higher VPD (drier air) pockets appear in many of the same eastern and central areas that are warmer
- The co-location of high TMMX and high VPD indicates jointly hot-dry conditions that elevate fire potential

```{r}
plot_raster(object2, "PR",   bins = 70)
``` 

PR(precipitation) binned raster map
- Precipitation is patchy and relatively low over much of the domain
- Where PR is higher, ERC tends to be lower in the ERC map (Figure 7), consistent with wetting effects

```{r}
plot_raster(object2, "VS",   bins = 70)
```

VS(Wind Speed) binned raster map
- Wind has localized maxima rather than a single gradient
- These wind pockets may not align perfectly with ERC spatial highs, which is consistent with wind acting more as a spread/short-term enhancer than a persistent background driver.

```{r}
plot_raster(object2, "ERC",  bins = 70)
```

ERC binned raster map
- ERC is elevated in clusters that overlap warmer and drier bins
- Spatial agreement with high TMMX and high VPD, and disagreement with high FM100, reinforces the correlation findings.

### 2.2. Scatter Plots

Scatter Plots

```{r}
ggplot(object2, aes(x = TMMX, y = BI)) +geom_point(alpha = 0.4)+     geom_smooth(method = "lm", se = FALSE, color = "red")+labs(title = "Fire Index vs. Temperature")
```

BI vs. TMMX
- The fitted line shows a weak relationship and the distribution is dominated by many zero or near-zero BI values. This zero inflation and visible heteroscedasticity limit the usefulness of simple bivariate OLS. A multivariable model that controls for dryness (VPD), fuel moisture (FM100), wind (VS), and precipitation (PR) is more appropriate. If the goal is to model BI directly, consider restricting to BI > 0 or using a model that handles zero inflation or nonlinearity.

### 2.3 Regression Diagnostics Plots

Regression Diagnostics Plots

```{r}
model <- lm(BI ~ TMMX + PR + VS + VPD, data = object2)
par(mfrow = c(2, 2))
plot(model)  # residuals, Q-Q, leverage plots
```

OLS diagnostic for BI model
- Residuals vs. fitted values display a fan shape and curvature, which indicates heteroscedasticity and potential nonlinearity
- The Q–Q plot shows tail deviations, suggesting heavy-tailed residuals and outliers. The scale-location plot confirms nonconstant variance.
- The residuals vs leverage plot highlights a few influential observations. These patterns show that standard OLS assumptions are not well met and motivate spatial regression or robust alternatives.

### 2.4 Spatial Regression

```{r eval=FALSE}
# Build spatial dataset and weights for modeling
# Collapse to one record per location to avoid duplicate coordinates by date
o2 <- object2 |>
  dplyr::group_by(LONGITUDE, LATITUDE) |>
  dplyr::summarise(dplyr::across(c(PR, RMAX, RMIN, SPH, SRAD, TMMN, TMMX, VS,
                                   FM100, FM1000, ERC, ETR, PET, VPD),
                                 ~mean(.x, na.rm = TRUE)),
                   .groups = "drop")

#| label: spatial-weights
vars <- c("ERC","TMMX","VPD","FM100","PR","VS","RMAX","SRAD")
dat  <- na.omit(o2[, vars, drop = FALSE])

coords_all <- as.matrix(o2[, c("LONGITUDE","LATITUDE")])
coords_k   <- coords_all[as.numeric(rownames(dat)), , drop = FALSE]

kn1  <- spdep::knearneigh(coords_k, k = 1, longlat = TRUE)
dmax <- max(kn1$nn.dist)
nb_k <- spdep::dnearneigh(coords_k, d1 = 0, d2 = dmax * 1.05, longlat = TRUE)

while (any(spdep::card(nb_k) == 0)) {
  dmax <- dmax * 1.2
  nb_k <- spdep::dnearneigh(coords_k, d1 = 0, d2 = dmax, longlat = TRUE)
}
if (spdep::n.comp.nb(nb_k)$nc > 1) {
  k <- 5
  repeat {
    nb_k <- spdep::knn2nb(spdep::knearneigh(coords_k, k = k, longlat = TRUE))
    if (spdep::n.comp.nb(nb_k)$nc == 1 || k >= 20) break
    k <- k + 1
  }
}

lw_k <- spdep::nb2listw(nb_k, style = "W", zero.policy = FALSE)
```

```{r eval=FALSE}
# Fit models
ols <- lm(ERC ~ TMMX + VPD + FM100 + PR + VS + RMAX + SRAD, data = dat)
sar <- lagsarlm(ERC ~ TMMX + VPD + FM100 + PR + VS + RMAX + SRAD,
                data = dat, listw = lw_k, zero.policy = TRUE, na.action = na.exclude)
sem <- errorsarlm(ERC ~ TMMX + VPD + FM100 + PR + VS + RMAX + SRAD,
                  data = dat, listw = lw_k, zero.policy = TRUE, na.action = na.exclude)

# Summaries
summary(ols); summary(sar); summary(sem); AIC(sar, sem)

# Spatial autocorrelation of residuals
spdep::lm.morantest(ols, lw_k, zero.policy = TRUE)         # OLS
moran.test(residuals(sar), lw_k, zero.policy = TRUE)        # SAR
moran.test(residuals(sem), lw_k, zero.policy = TRUE)        # SEM
```

Residual spatial autocorrelation after SEM.
Moran’s I on the SEM residuals is not significant (I ≈ −0.059, z ≈ −0.76, p ≈ 0.78). This indicates that the spatial error model adequately removed spatial clustering in the residuals. In practical terms, the spatial structure is captured by the model and remaining errors are close to spatially random.

## Object2 Conclusion

Across figures, hotter and drier conditions (higher TMMX and VPD) spatially coincide with higher ERC, while higher fuel moisture (FM100 and FM1000) opposes ERC. Precipitation and humidity indicators also oppose ERC but with patchier spatial expression. Wind shows localized peaks and likely modulates spread rather than setting the background hazard. These visual patterns match the correlation matrix and justify focusing the spatial regression on TMMX, VPD, and one fuel-moisture variable (FM100) while avoiding FM100 and FM1000 together due to collinearity.

- last edit by simba
- added other plots and finialising it(Jeongwon)